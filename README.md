# tutorial-loggly-api-proxy
Basic tutorial of an API Proxy running on Apigee leveraging Loggly and Apigee standard output.

![Log Management for Modern APIs](https://www.dropbox.com/s/70g4kiyde2nwwt4/Log%20Management%20for%20Modern%20APIs.png?dl=1)

In the previous diagram an API Proxy in Apigee leverages a Log Management solution to log events. The API Proxy leverages standard libraries such as [Winston][https://github.com/winstonjs/winston] or (Bunyan)[https://github.com/trentm/node-bunyan] to log entries in an async fashion, so there's little impact on latency.

#### How to deploy this API Proxy
We will be leveraging [apigeetool](https://www.npmjs.com/package/apigeetool) to bundle and deploy it to Apigee Edge. You'll need to sign up for a Free Apigee Edge account [here](https://accounts.apigee.com/accounts/sign_up).

```bash
$ apigeetool deploynodeapp --username $ae_username --password $ae_password --organization testmyapi --api tutorial-loggly-api-proxy --environment test --directory . -m app.js -b /tutorial-loggly-api-proxy
```

#### Enabling Winston
All steps included in this how-to-guide are standard to Winston configuration available [here](https://github.com/winstonjs/winston), including (Winston-Loggly)[https://github.com/winstonjs/winston-loggly], which a Winston transporter for Loggly. So, there's nothing specific about Apigee to support it, except that Apigee requires to import Node.js Apps as Apigee API Proxy bundles, which is explained in How to deploy this API Proxy section.


#### How to test it
We will generate two types of exceptions. Custom and ReferenceError Exceptions. These two exception could be generated further in the stack and both are intercepted by Express and reported by the logger.

```javascript
app.get('/pets', function(req, res){
	  logger.info('access to /pets resource');
	  if(req.query.error === 'code_raised'){ // raised exception
	    logger.error("Error raised by an exception");
	    throw new Error("Raised by an exception!")
	  }else if(req.query.error === 'reference'){ //invalid function
	    foo();
	  }
	  res.json(pets);
});
```

```/pets?error=code_raised``` will raise an exception by explicitly throwing the exception and ```/pets?error=reference``` will raise a refence error.

##### Throwing an explicit exception
This exception is raised by the following code in /pets route.

```bash
$ curl http://testmyapi-test.apigee.net/tutorial-loggly-api-proxy/pets?error=code_raised
```
**Response:**
```
{"message":"Woops! Looks like something broke!","type":"ERROR-0001","messageid":"rrt011ea_BTMm+ALU_RouterProxy-2-514155_1"}
```

##### Exception generated by Reference Error
Since foo function doesn't exist a Reference Error exception will be generated.
```bash
$ curl http://testmyapi-test.apigee.net/tutorial-loggly-api-proxy/pets?error=reference
```
**Response:**
```javascript
{"message":"Woops! Looks like something broke!","type":"ERROR-0001","messageid":"rrt17apigee_BTMini/M_RouterProxy-2-565998_1"}
```

##### Check entries in Loggly
